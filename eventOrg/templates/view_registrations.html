<!-- templates/view_registrations.html -->
{% extends "base.html" %}

{% block title %}Event Registrations{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1 class="page-title">Event Registrations</h1>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
        <div>
            <select id="eventFilter" class="form-control" style="width: auto;" onchange="filterByEvent()">
                <option value="all">All Events</option>
                {% for event in all_events %}
                <option value="{{ event.id }}" {% if selected_event_id == event.id %}selected{% endif %}>
                    {{ event.event_name }} ({{ event.event_date }})
                </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <select id="statusFilter" class="form-control" style="width: auto; margin-left: 10px;" onchange="filterRegistrations()">
                <option value="all">All Status</option>
                <option value="Pending">Pending</option>
                <option value="Confirmed">Confirmed</option>
                <option value="Attended">Attended</option>
                <option value="No-show">No-show</option>
            </select>
        </div>
    </div>
</div>

<!-- Registrations Table -->
<div class="table-container fade-in">
    <div class="table-header">
        <h3><i class="fas fa-users"></i> Donor Registrations</h3>
        {% if selected_event %}
        <span style="color: white;">Event: {{ selected_event.event_name }} ({{ selected_event.event_date }})</span>
        {% endif %}
    </div>
    
    {% if registrations %}
    <table id="registrationsTable">
        <thead>
            <tr>
                <th>Donor Name</th>
                <th>Email</th>
                <th>Blood Type</th>
                <th>Registration Date</th>
                <th>Status</th>
                <th>Attendance</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for reg in registrations %}
            <tr data-status="{{ reg.status }}">
                <td>{{ reg.donor_name or 'N/A' }}</td>
                <td>{{ reg.email or 'N/A' }}</td>
                <td>
                    {% if reg.blood_type %}
                    <span style="background-color: #ffebee; color: #d32f2f; padding: 0.25rem 0.5rem; border-radius: 4px;">
                        {{ reg.blood_type }}
                    </span>
                    {% else %}
                    N/A
                    {% endif %}
                </td>
                <td>{{ reg.registered_at }}</td>
                <td>
                    {% if reg.status == 'Pending' %}
                    <span class="status-badge status-upcoming">{{ reg.status }}</span>
                    {% elif reg.status == 'Confirmed' %}
                    <span class="status-badge status-ongoing">{{ reg.status }}</span>
                    {% elif reg.status == 'Attended' %}
                    <span class="status-badge status-completed">{{ reg.status }}</span>
                    {% else %}
                    <span class="status-badge status-cancelled">{{ reg.status }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if reg.check_in_time %}
                    <span style="color: var(--success);">
                        <i class="fas fa-check-circle"></i> Attended
                    </span>
                    {% else %}
                    <span style="color: var(--dark-gray);">
                        <i class="fas fa-clock"></i> Not Yet
                    </span>
                    {% endif %}
                </td>
                <td>
                    <div style="display: flex; gap: 5px;">
                        {% if reg.status == 'Pending' %}
                        <button onclick="updateRegistrationStatus('{{ reg.id }}', 'Confirmed')" class="btn btn-success btn-sm">
                            <i class="fas fa-check"></i> Confirm
                        </button>
                        {% endif %}
                        
                        {% if reg.status == 'Confirmed' and not reg.check_in_time %}
                        <button onclick="markAttendance('{{ reg.id }}')" class="btn btn-primary btn-sm">
                            <i class="fas fa-user-check"></i> Mark Present
                        </button>
                        {% endif %}
                        
                        {% if reg.status != 'No-show' %}
                        <button onclick="updateRegistrationStatus('{{ reg.id }}', 'No-show')" class="btn btn-danger btn-sm">
                            <i class="fas fa-times"></i> No-show
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="padding: 3rem; text-align: center; color: var(--dark-gray);">
        <i class="fas fa-user-slash" style="font-size: 4rem; margin-bottom: 1rem;"></i>
        <h3>No Registrations Found</h3>
        <p>No donors have registered for this event yet.</p>
    </div>
    {% endif %}
</div>

<!-- Registration Statistics -->
{% if selected_event %}
<div class="grid fade-in" style="animation-delay: 0.2s;">
    <div class="card">
        <h3><i class="fas fa-chart-pie"></i> Registration Statistics</h3>
        <div style="margin-top: 1rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Total Registrations:</span>
                <strong>{{ total_registrations_count }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Confirmed:</span>
                <strong>{{ confirmed_count }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>Attended:</span>
                <strong>{{ attended_count }}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Attendance Rate:</span>
                <strong>{{ attendance_rate }}%</strong>
            </div>
        </div>
    </div>
    
    <div class="card">
        <h3><i class="fas fa-tint"></i> Blood Type Distribution</h3>
        <div style="margin-top: 1rem;">
            {% for blood_type, count in blood_type_distribution.items() %}
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span>{{ blood_type or 'Unknown' }}:</span>
                <strong>{{ count }}</strong>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function filterByEvent() {
    const eventId = document.getElementById('eventFilter').value;
    if (eventId === 'all') {
        window.location.href = "{{ url_for('view_registrations') }}";
    } else {
        window.location.href = "{{ url_for('view_registrations') }}?event_id=" + eventId;
    }
}

function filterRegistrations() {
    const filterValue = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('#registrationsTable tbody tr');
    
    rows.forEach(row => {
        if (filterValue === 'all' || row.getAttribute('data-status') === filterValue) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

function updateRegistrationStatus(registrationId, status) {
    if (confirm(`Are you sure you want to update this registration to "${status}"?`)) {
        fetch(`/registration/${registrationId}/status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: status })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to update registration status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to update registration status');
        });
    }
}

function markAttendance(registrationId) {
    fetch(`/registration/${registrationId}/attendance`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to mark attendance');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to mark attendance');
    });
}
</script>
{% endblock %}