<!DOCTYPE html>
<html>
<head>
    <title>Donor List - BloodLink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<header>
    <div class="header-container">
        <!-- Logo on the left -->
        <div style="display: flex; align-items: center; gap: 10px;">
            <a href="{{ url_for('staff_dashboard') }}" class="logo">
                <i class="fas fa-tint"></i> BloodLink Staff
            </a>
            <a href="{{ url_for('staff_dashboard') }}" class="btn btn-outline" 
               style="color: var(--primary-red); border-color: var(--primary-red); padding: 8px 15px; font-size: 0.9rem;">
                <i class="fas fa-home"></i> Home
            </a>
        </div>
        
        <!-- Hamburger menu on the right -->
        <div class="header-right">
            {% if session.get('staff_name') %}
            <span class="welcome-text">
                <i class="fas fa-user"></i> {{ session.staff_name }}
            </span>
            {% endif %}
            <button class="btn btn-menu" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>
</header>

<!-- Overlay (for mobile) -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar on the RIGHT -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>Staff Menu</span>
        <button class="close-btn" onclick="toggleSidebar()">&times;</button>
    </div>
    <nav class="sidebar-nav">
        <a href="{{ url_for('staff_dashboard') }}"><i class="fas fa-home"></i> Dashboard</a>
        <a href="{{ url_for('view_inventory') }}"><i class="fas fa-boxes"></i> Inventory</a>
        <a href="{{ url_for('donor_list') }}" class="active"><i class="fas fa-users"></i> Donors</a>
        <a href="{{ url_for('view_requests') }}"><i class="fas fa-bell"></i> Requests</a>
        <a href="{{ url_for('create_request') }}"><i class="fas fa-plus-circle"></i> New Request</a>
        <hr>
        <a href="{{ url_for('logout') }}" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
</div>

<div class="page-container">
    <div class="card">
        <div class="header-actions">
            <h2 style="margin: 0;"><i class="fas fa-users"></i> Donor Management</h2>
            <button class="btn btn-primary" onclick="openAddDonorModal()">
                <i class="fas fa-user-plus"></i> Add New Donor
            </button>
        </div>
        
        <!-- Statistics -->
        <div class="stats-row" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 25px 0;">
            {% set eligible_count = donors|selectattr('eligibility_status', 'equalto', true)|list|length %}
            {% set universal_count = donors|selectattr('blood_type', 'equalto', 'O-')|list|length %}
            
            <div class="stat-box" style="background: #c00; color: white; padding: 15px; border-radius: var(--radius); text-align: center;">
                <div style="font-size: 2rem; font-weight: bold;">{{ donors|length }}</div>
                <div>Total Donors</div>
            </div>
            <div class="stat-box" style="background: #28a745; color: white; padding: 15px; border-radius: var(--radius); text-align: center;">
                <div style="font-size: 2rem; font-weight: bold;">{{ eligible_count }}</div>
                <div>Eligible Donors</div>
            </div>
            <div class="stat-box" style="background: #6f42c1; color: white; padding: 15px; border-radius: var(--radius); text-align: center;">
                <div style="font-size: 2rem; font-weight: bold;">{{ universal_count }}</div>
                <div>Universal (O-) Donors</div>
            </div>
        </div>
        
        <!-- Search and Filter -->
        <div class="search-filter-bar" style="background: white; padding: 15px; border-radius: var(--radius); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <input type="text" id="searchDonor" placeholder="Search by name or email..." 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <select id="filterBloodType" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 120px;">
                    <option value="">All Blood Types</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                </select>
            </div>
            <div>
                <select id="filterEligibility" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 140px;">
                    <option value="">All Eligibility</option>
                    <option value="eligible">Eligible</option>
                    <option value="not-eligible">Not Eligible</option>
                </select>
            </div>
            <div>
                <button id="clearFilters" class="btn btn-outline" style="padding: 10px 15px;">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>
        
        <!-- Donors Table -->
        <div class="table-container">
            <table class="data-table" id="donorsTable">
                <thead>
                    <tr>
                        <th>Donor Name</th>
                        <th>Blood Type</th>
                        <th>Age</th>
                        <th>Eligibility</th>
                        <th>Last Donation</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if donors %}
                        {% for donor in donors %}
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div class="avatar-circle" style="width: 40px; height: 40px; border-radius: 50%; background: #c00; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                                            {{ donor.donor_name[0] if donor.donor_name else '?' }}
                                        </div>
                                        <div>
                                            <strong>{{ donor.donor_name or 'Unknown' }}</strong><br>
                                            <small style="color: #666;">{{ donor.email if donor.email else 'No email' }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if donor.blood_type %}
                                        {% if donor.blood_type in ['A+', 'A-'] %}
                                            <span class="blood-badge" style="padding: 5px 10px; border-radius: 15px; font-weight: bold; background: #dc3545; color: white;">
                                                {{ donor.blood_type }}
                                            </span>
                                        {% elif donor.blood_type in ['B+', 'B-'] %}
                                            <span class="blood-badge" style="padding: 5px 10px; border-radius: 15px; font-weight: bold; background: #198754; color: white;">
                                                {{ donor.blood_type }}
                                            </span>
                                        {% elif donor.blood_type in ['AB+', 'AB-'] %}
                                            <span class="blood-badge" style="padding: 5px 10px; border-radius: 15px; font-weight: bold; background: #0d6efd; color: white;">
                                                {{ donor.blood_type }}
                                            </span>
                                        {% elif donor.blood_type in ['O+', 'O-'] %}
                                            <span class="blood-badge" style="padding: 5px 10px; border-radius: 15px; font-weight: bold; background: #6f42c1; color: white;">
                                                {{ donor.blood_type }}
                                            </span>
                                        {% else %}
                                            <span class="blood-badge" style="padding: 5px 10px; border-radius: 15px; font-weight: bold; background: #6c757d; color: white;">
                                                {{ donor.blood_type }}
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="blood-badge" style="padding: 5px 10px; border-radius: 15px; font-weight: bold; background: #6c757d; color: white;">
                                            Unknown
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ donor.age if donor.age else 'N/A' }}</td>
                                <td>
                                    {% if donor.eligibility_status %}
                                        <span class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;">
                                            <i class="fas fa-check-circle"></i> Eligible
                                        </span>
                                    {% else %}
                                        <span class="badge" style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;">
                                            <i class="fas fa-times-circle"></i> Not Eligible
                                        </span>
                                        {% if donor.disqualification_reason %}
                                            <br><small style="color: #666;">{{ donor.disqualification_reason }}</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if donor.last_donation_date %}
                                        {{ donor.last_donation_date }}
                                    {% else %}
                                        <span style="color: #999;">Never</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons" style="display: flex; gap: 5px;">
                                        <button class="btn btn-outline-primary view-donor" 
                                                data-donor-id="{{ donor.id }}"
                                                style="padding: 8px 12px; font-size: 0.9rem; border-radius: 8px;">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn btn-outline-warning toggle-eligibility"
                                                data-donor-id="{{ donor.id }}"
                                                data-current-status="{{ 'true' if donor.eligibility_status else 'false' }}"
                                                style="padding: 8px 12px; font-size: 0.9rem; border-radius: 8px;">
                                            {% if donor.eligibility_status %}
                                                <i class="fas fa-ban"></i> Disqualify
                                            {% else %}
                                                <i class="fas fa-check"></i> Qualify
                                            {% endif %}
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-user-slash fa-2x" style="margin-bottom: 15px; color: #ddd;"></i>
                                <p>No donors found.</p>
                                <button class="btn btn-primary" onclick="openAddDonorModal()" style="margin-top: 10px;">
                                    <i class="fas fa-user-plus"></i> Add First Donor
                                </button>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Donor Modal -->
<div id="addDonorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-user-plus"></i> Add New Donor
            </h2>
            <button class="modal-close" onclick="closeAddDonorModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="addDonorForm">
            <div class="form-group">
                <label><i class="fas fa-user"></i> Full Name *</label>
                <input type="text" class="form-input" name="donor_name" required 
                       style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #ddd;">
            </div>
            <div class="form-group">
                <label><i class="fas fa-envelope"></i> Email *</label>
                <input type="email" class="form-input" name="email" required 
                       style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #ddd;">
            </div>
            <div class="form-row" style="display: flex; gap: 15px;">
                <div class="form-group" style="flex: 1;">
                    <label><i class="fas fa-birthday-cake"></i> Age</label>
                    <input type="number" class="form-input" name="age" min="18" max="65" 
                           style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #ddd;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label><i class="fas fa-tint"></i> Blood Type *</label>
                    <select class="form-input" name="blood_type" required 
                            style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #ddd;">
                        <option value="">Select</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label><i class="fas fa-clipboard-check"></i> Initial Eligibility Status</label>
                <select class="form-input" name="eligibility_status" 
                        style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #ddd;">
                    <option value="true">Eligible</option>
                    <option value="false">Not Eligible</option>
                </select>
            </div>
            <div class="form-group">
                <label><i class="fas fa-file-medical"></i> Medical History</label>
                <textarea class="form-input" name="medical_history" rows="3" 
                          style="padding: 12px; font-size: 1rem; border-radius: 8px; border: 1px solid #ddd;"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeAddDonorModal()" 
                        style="padding: 12px 25px;">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn btn-primary" id="saveDonorBtn" 
                        style="padding: 12px 25px;">
                    <i class="fas fa-save"></i> Save Donor
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Donor Details Modal -->
<div id="donorDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-user-circle"></i> Donor Details
            </h2>
            <button class="modal-close" onclick="closeDonorDetailsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="donorDetailsContent" class="details-grid">
            <!-- Content will be loaded here -->
        </div>
        
        <div class="modal-footer">
            <button onclick="closeDonorDetailsModal()" class="btn btn-outline" style="padding: 12px 25px;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
// Donor filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchDonor');
    const bloodTypeFilter = document.getElementById('filterBloodType');
    const eligibilityFilter = document.getElementById('filterEligibility');
    const clearBtn = document.getElementById('clearFilters');
    const tableRows = document.querySelectorAll('#donorsTable tbody tr');
    
    if (!searchInput || !tableRows.length) return;
    
    function filterDonors() {
        const searchTerm = searchInput.value.toLowerCase();
        const bloodType = bloodTypeFilter.value;
        const eligibility = eligibilityFilter.value;
        
        tableRows.forEach(row => {
            const name = row.cells[0].textContent.toLowerCase();
            const email = row.cells[0].querySelector('small')?.textContent.toLowerCase() || '';
            const bloodTypeCell = row.cells[1].textContent;
            const eligibilityCell = row.cells[3].textContent;
            
            const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
            const matchesBloodType = !bloodType || bloodTypeCell === bloodType;
            const matchesEligibility = !eligibility || 
                (eligibility === 'eligible' && eligibilityCell.includes('Eligible')) ||
                (eligibility === 'not-eligible' && eligibilityCell.includes('Not Eligible'));
            
            row.style.display = (matchesSearch && matchesBloodType && matchesEligibility) ? '' : 'none';
        });
    }
    
    searchInput.addEventListener('input', filterDonors);
    bloodTypeFilter.addEventListener('change', filterDonors);
    eligibilityFilter.addEventListener('change', filterDonors);
    
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            bloodTypeFilter.value = '';
            eligibilityFilter.value = '';
            tableRows.forEach(row => row.style.display = '');
        });
    }
});

// Modal functions
function openAddDonorModal() {
    document.getElementById('addDonorModal').style.display = 'flex';
    document.getElementById('addDonorForm').reset();
}

function closeAddDonorModal() {
    document.getElementById('addDonorModal').style.display = 'none';
}

function closeDonorDetailsModal() {
    document.getElementById('donorDetailsModal').style.display = 'none';
}

// Close modals when clicking outside
document.getElementById('addDonorModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddDonorModal();
    }
});

document.getElementById('donorDetailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDonorDetailsModal();
    }
});

// Close modals with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        if (document.getElementById('addDonorModal').style.display === 'flex') {
            closeAddDonorModal();
        }
        if (document.getElementById('donorDetailsModal').style.display === 'flex') {
            closeDonorDetailsModal();
        }
    }
});

// Add donor form submission
document.getElementById('addDonorForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    const saveBtn = document.getElementById('saveDonorBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    try {
        const response = await fetch('/staff/donors/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Donor added successfully!', 'success');
            closeAddDonorModal();
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            showToast('Error: ' + result.error, 'error');
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('An error occurred. Please try again.', 'error');
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
});

// View donor details with beautiful modal
document.querySelectorAll('.view-donor').forEach(button => {
    button.addEventListener('click', async function() {
        const donorId = this.getAttribute('data-donor-id');
        
        // Show loading state
        const modalContent = document.getElementById('donorDetailsContent');
        modalContent.innerHTML = `
            <div class="loading-spinner" style="grid-column: 1 / -1;">
                <div class="spinner"></div>
                <p>Loading donor details...</p>
            </div>
        `;
        
        document.getElementById('donorDetailsModal').style.display = 'flex';
        
        try {
            const response = await fetch('/staff/donors/' + donorId);
            const result = await response.json();
            
            if (result.success) {
                const donor = result.donor;
                
                // Build beautiful modal content
                const detailsHtml = `
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <div class="detail-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <div class="detail-label">Full Name</div>
                                <div class="detail-value" style="font-size: 1.2rem; font-weight: 600;">${donor.donor_name || 'Not specified'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <div class="detail-icon" style="background: linear-gradient(135deg, #17a2b8, #138496);">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div>
                                <div class="detail-label">Email Address</div>
                                <div class="detail-value">${donor.email || 'Not provided'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <div class="detail-icon" style="background: linear-gradient(135deg, #6f42c1, #5a32a3);">
                                <i class="fas fa-birthday-cake"></i>
                            </div>
                            <div>
                                <div class="detail-label">Age</div>
                                <div class="detail-value">${donor.age || 'Not specified'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-card blood-type-card">
                        <div class="detail-card-header">
                            <div class="detail-icon">
                                <i class="fas fa-tint"></i>
                            </div>
                            <div>
                                <div class="detail-label">Blood Type</div>
                                <div class="detail-value">
                                    <span class="badge badge-primary" style="font-size: 1.1rem; padding: 10px 20px;">
                                        ${donor.blood_type || 'Unknown'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-card status-card">
                        <div class="detail-card-header">
                            <div class="detail-icon">
                                <i class="fas fa-clipboard-check"></i>
                            </div>
                            <div>
                                <div class="detail-label">Eligibility Status</div>
                                <div class="detail-value">
                                    ${donor.eligibility_status ? 
                                        '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Eligible</span>' : 
                                        '<span class="badge badge-danger"><i class="fas fa-times-circle"></i> Not Eligible</span>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${donor.disqualification_reason && !donor.eligibility_status ? `
                    <div class="detail-card" style="grid-column: 1 / -1;">
                        <div class="detail-card-header">
                            <div class="detail-icon" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div>
                                <div class="detail-label">Disqualification Reason</div>
                                <div class="detail-value">${donor.disqualification_reason}</div>
                            </div>
                        </div>
                    </div>` : ''}
                    
                    <div class="detail-card medical-history-card" style="grid-column: 1 / -1;">
                        <div class="detail-card-header">
                            <div class="detail-icon">
                                <i class="fas fa-file-medical"></i>
                            </div>
                            <div>
                                <div class="detail-label">Medical History</div>
                                <div class="detail-value">
                                    ${donor.medical_history ? 
                                        `<div class="notes-box">
                                            ${donor.medical_history}
                                        </div>` : 
                                        '<em style="color: #999; font-style: italic;">No medical history provided</em>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <div class="detail-icon" style="background: linear-gradient(135deg, #ffc107, #e0a800);">
                                <i class="fas fa-history"></i>
                            </div>
                            <div>
                                <div class="detail-label">Last Donation</div>
                                <div class="detail-value">${donor.last_donation_date || 'Never donated'}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-card">
                        <div class="detail-card-header">
                            <div class="detail-icon" style="background: linear-gradient(135deg, #6c757d, #545b62);">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div>
                                <div class="detail-label">Registration Date</div>
                                <div class="detail-value">${donor.created_at ? donor.created_at.slice(0,10) : 'Unknown'}</div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('donorDetailsContent').innerHTML = detailsHtml;
            } else {
                document.getElementById('donorDetailsContent').innerHTML = `
                    <div class="loading-spinner" style="grid-column: 1 / -1; color: #dc3545;">
                        <div class="spinner" style="border-color: rgba(220, 53, 69, 0.1); border-top-color: #dc3545;"></div>
                        <h3 style="margin-bottom: 10px;">Error Loading Details</h3>
                        <p>${result.error || 'Unable to load donor information'}</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('donorDetailsContent').innerHTML = `
                <div class="loading-spinner" style="grid-column: 1 / -1; color: #dc3545;">
                    <div class="spinner" style="border-color: rgba(220, 53, 69, 0.1); border-top-color: #dc3545;"></div>
                    <h3 style="margin-bottom: 10px;">Network Error</h3>
                    <p>Failed to load donor details. Please check your connection.</p>
                </div>
            `;
        }
    });
});

// Toggle eligibility
document.querySelectorAll('.toggle-eligibility').forEach(button => {
    button.addEventListener('click', async function() {
        const donorId = this.getAttribute('data-donor-id');
        const currentStatus = this.getAttribute('data-current-status') === 'true';
        const newStatus = !currentStatus;
        
        if (confirm(`Are you sure you want to ${currentStatus ? 'disqualify' : 'qualify'} this donor?`)) {
            const originalButton = this;
            originalButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            originalButton.disabled = true;
            
            try {
                const response = await fetch('/staff/donors/toggle-eligibility', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ donor_id: donorId, new_status: newStatus })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    if (newStatus) {
                        originalButton.innerHTML = '<i class="fas fa-ban"></i>';
                        originalButton.style.color = '#dc3545';
                        originalButton.setAttribute('data-current-status', 'true');
                    } else {
                        originalButton.innerHTML = '<i class="fas fa-check"></i>';
                        originalButton.style.color = '#28a745';
                        originalButton.setAttribute('data-current-status', 'false');
                    }
                    
                    // Update the eligibility badge in table
                    const row = originalButton.closest('tr');
                    const eligibilityCell = row.cells[3];
                    
                    if (newStatus) {
                        eligibilityCell.innerHTML = '<span class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;"><i class="fas fa-check-circle"></i> Eligible</span>';
                    } else {
                        eligibilityCell.innerHTML = '<span class="badge" style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;"><i class="fas fa-times-circle"></i> Not Eligible</span>';
                    }
                    
                    showToast('Donor eligibility updated!', 'success');
                } else {
                    showToast('Error: ' + result.error, 'error');
                    originalButton.innerHTML = currentStatus ? '<i class="fas fa-ban"></i>' : '<i class="fas fa-check"></i>';
                    originalButton.disabled = false;
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred. Please try again.', 'error');
                originalButton.innerHTML = currentStatus ? '<i class="fas fa-ban"></i>' : '<i class="fas fa-check"></i>';
                originalButton.disabled = false;
            }
        }
    });
});
</script>
</body>
</html>
