<!DOCTYPE html>
<html>
<head>
    <title>View Requests - BloodLink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<header>
    <div class="header-container">
        <!-- Logo on the left -->
        <div style="display: flex; align-items: center; gap: 10px;">
            <a href="{{ url_for('staff_dashboard') }}" class="logo">
                <i class="fas fa-tint"></i> BloodLink Staff
            </a>
            <a href="{{ url_for('staff_dashboard') }}" class="btn btn-outline" 
               style="color: var(--primary-red); border-color: var(--primary-red); padding: 8px 15px; font-size: 0.9rem;">
                <i class="fas fa-home"></i> Home
            </a>
        </div>
        
        <!-- Hamburger menu on the right -->
        <div class="header-right">
            {% if session.get('staff_name') %}
            <span class="welcome-text">
                <i class="fas fa-user"></i> {{ session.staff_name }}
            </span>
            {% endif %}
            <button class="btn btn-menu" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>
</header>

<!-- Overlay (for mobile) -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- Sidebar on the RIGHT -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>Staff Menu</span>
        <button class="close-btn" onclick="toggleSidebar()">&times;</button>
    </div>
    <nav class="sidebar-nav">
        <a href="{{ url_for('staff_dashboard') }}"><i class="fas fa-home"></i> Dashboard</a>
        <a href="{{ url_for('view_inventory') }}"><i class="fas fa-boxes"></i> Inventory</a>
        <a href="{{ url_for('donor_list') }}"><i class="fas fa-users"></i> Donors</a>
        <a href="{{ url_for('view_requests') }}" class="active"><i class="fas fa-bell"></i> Requests</a>
        <a href="{{ url_for('create_request') }}"><i class="fas fa-plus-circle"></i> New Request</a>
        <hr>
        <a href="{{ url_for('logout') }}" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
</div>

<div class="page-container">
    <div class="card">
        <div class="header-actions">
            <h2 style="margin: 0;"><i class="fas fa-bell"></i> Urgent Blood Requests</h2>
            <a href="{{ url_for('create_request') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> New Request
            </a>
        </div>
        
        <!-- Statistics -->
        <!-- Search and Filter Section -->
        <div class="search-filter-bar" style="background: white; padding: 15px; border-radius: var(--radius); margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <input type="text" id="searchRequest" placeholder="Search by hospital..." 
                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
                <select id="filterStatus" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 120px;">
                    <option value="">All Status</option>
                    <option value="Pending">Pending</option>
                    <option value="Fulfilled">Fulfilled</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            <div>
                <select id="filterUrgency" style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; min-width: 120px;">
                    <option value="">All Urgency</option>
                    <option value="High">High</option>
                    <option value="Medium">Medium</option>
                    <option value="Low">Low</option>
                </select>
            </div>
            <div>
                <button id="clearRequestFilters" class="btn btn-outline" style="padding: 10px 15px;">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>
        
        <!-- Requests Table -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Blood Type</th>
                        <th>Units Needed</th>
                        <th>Urgency</th>
                        <th>Status</th>
                        <th>Hospital</th>
                        <th>Date/Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if requests %}
                        {% for request in requests %}
                            <tr>
                                <td>#{{ request.id or loop.index }}</td>
                                <td>
                                    <span class="blood-badge" style="background: #c00; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold;">
                                        {{ request.blood_type }}
                                    </span>
                                </td>
                                <td>
                                    <strong>{{ request.units_needed }}</strong>
                                    <small style="color: #666;"> units</small>
                                </td>
                                <td>
                                    {% if request.urgency_level == 'High' %}
                                        <span class="badge" style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;">
                                            <i class="fas fa-exclamation-circle"></i> High
                                        </span>
                                    {% elif request.urgency_level == 'Medium' %}
                                        <span class="badge" style="background: #ffc107; color: #333; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;">
                                            <i class="fas fa-clock"></i> Medium
                                        </span>
                                    {% else %}
                                        <span class="badge" style="background: #17a2b8; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;">
                                            <i class="fas fa-calendar"></i> Low
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if request.status == 'Pending' %}
                                        <span class="badge" style="background: #ffc107; color: #333; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;">
                                            <i class="fas fa-hourglass-half"></i> Pending
                                        </span>
                                    {% elif request.status == 'Fulfilled' %}
                                        <span class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;">
                                            <i class="fas fa-check-circle"></i> Fulfilled
                                        </span>
                                    {% elif request.status == 'Cancelled' %}
                                        <span class="badge" style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;">
                                            <i class="fas fa-times-circle"></i> Cancelled
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ request.hospital_name or session.hospital_name or 'Hospital' }}</td>
                                <td>
                                    {% if request.requested_at %}
                                        {{ request.requested_at[:10] }}<br>
                                        <small style="color: #666;">{{ request.requested_at[11:16] }}</small>
                                    {% else %}
                                        <span style="color: #999;">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons" style="display: flex; gap: 5px;">
                                        <button class="btn btn-outline view-details" 
                                                data-request-id="{{ request.id or loop.index }}"
                                                style="padding: 5px 10px; font-size: 0.85rem;">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if request.status == 'Pending' %}
                                            <button class="btn btn-outline-success fulfill-request"
                                                    data-request-id="{{ request.id or loop.index }}"
                                                    style="padding: 5px 10px; font-size: 0.85rem;">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="btn btn-outline-danger cancel-request"
                                                    data-request-id="{{ request.id or loop.index }}"
                                                    style="padding: 5px 10px; font-size: 0.85rem;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-outline-info notify-donors"
                                                data-request-id="{{ request.id or loop.index }}"
                                                data-blood-type="{{ request.blood_type }}"
                                                style="padding: 5px 10px; font-size: 0.85rem;">
                                            <i class="fas fa-bell"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-inbox fa-2x" style="margin-bottom: 15px; color: #ddd;"></i>
                                <p>No urgent requests found.</p>
                                <a href="{{ url_for('create_request') }}" class="btn btn-primary" style="margin-top: 10px;">
                                    <i class="fas fa-plus-circle"></i> Create Your First Request
                                </a>
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Urgent Request Details Modal -->
<div id="requestDetailsModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 class="modal-title">
                <i class="fas fa-file-medical-alt"></i> Request Details
            </h2>
            <button class="modal-close" onclick="closeRequestDetailsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="requestDetailsContent" class="details-grid">
            <!-- Content will be loaded here -->
        </div>
        
        <div class="modal-footer">
            <button onclick="closeRequestDetailsModal()" class="btn btn-outline" style="padding: 12px 25px;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
    </div>
</div>

<style>
/* Add these styles if not already present */
.request-detail-item {
    padding: 15px;
    background: #f9f9f9;
    border-radius: 10px;
    border-left: 4px solid var(--primary-red);
}

.request-detail-label {
    font-weight: 600;
    color: var(--text-medium);
    font-size: 0.9rem;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.request-detail-value {
    color: var(--text-dark);
    font-size: 1.1rem;
    font-weight: 500;
}

.urgency-high {
    background: #dc3545;
    color: white;
}

.urgency-medium {
    background: #ffc107;
    color: #333;
}

.urgency-low {
    background: #17a2b8;
    color: white;
}
</style>

<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
// View request details with modal
document.querySelectorAll('.view-details').forEach(button => {
    button.addEventListener('click', async function() {
        const requestId = this.getAttribute('data-request-id');
        
        // Show loading state
        const modalContent = document.getElementById('requestDetailsContent');
        modalContent.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary-red); margin-bottom: 20px;"></i>
                <p>Loading request details...</p>
            </div>
        `;
        
        document.getElementById('requestDetailsModal').style.display = 'flex';
        
        try {
            const response = await fetch('/staff/requests/' + requestId);
            const result = await response.json();
            
            if (result.success) {
                const request = result.request;
                
                // Determine urgency color
                let urgencyClass = '';
                let urgencyIcon = '';
                if (request.urgency_level === 'High') {
                    urgencyClass = 'urgency-high';
                    urgencyIcon = 'fa-exclamation-circle';
                } else if (request.urgency_level === 'Medium') {
                    urgencyClass = 'urgency-medium';
                    urgencyIcon = 'fa-clock';
                } else {
                    urgencyClass = 'urgency-low';
                    urgencyIcon = 'fa-calendar';
                }
                
                // Determine status color
                let statusClass = '';
                let statusIcon = '';
                if (request.status === 'Pending') {
                    statusClass = 'bg-warning text-dark';
                    statusIcon = 'fa-hourglass-half';
                } else if (request.status === 'Fulfilled') {
                    statusClass = 'bg-success text-white';
                    statusIcon = 'fa-check-circle';
                } else if (request.status === 'Cancelled') {
                    statusClass = 'bg-secondary text-white';
                    statusIcon = 'fa-times-circle';
                }
                
                // Build modal content
                const detailsHtml = `
                    <div class="request-detail-item">
                        <div class="request-detail-label">Request ID</div>
                        <div class="request-detail-value">#${request.id || 'N/A'}</div>
                    </div>
                    <div class="request-detail-item">
                        <div class="request-detail-label">Blood Type</div>
                        <div class="request-detail-value">
                            <span class="blood-badge" style="background: #c00; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 1.1rem;">
                                ${request.blood_type || 'Unknown'}
                            </span>
                        </div>
                    </div>
                    <div class="request-detail-item">
                        <div class="request-detail-label">Units Required</div>
                        <div class="request-detail-value" style="font-size: 1.5rem; font-weight: bold; color: var(--primary-red);">
                            ${request.units_needed || 0} units
                        </div>
                    </div>
                    <div class="request-detail-item">
                        <div class="request-detail-label">Urgency Level</div>
                        <div class="request-detail-value">
                            <span class="badge ${urgencyClass}" style="padding: 8px 16px; border-radius: 20px; font-size: 1rem;">
                                <i class="fas ${urgencyIcon}"></i> ${request.urgency_level || 'Not specified'}
                            </span>
                        </div>
                    </div>
                    <div class="request-detail-item">
                        <div class="request-detail-label">Status</div>
                        <div class="request-detail-value">
                            <span class="badge ${statusClass}" style="padding: 8px 16px; border-radius: 20px; font-size: 1rem;">
                                <i class="fas ${statusIcon}"></i> ${request.status || 'Unknown'}
                            </span>
                        </div>
                    </div>
                    <div class="request-detail-item">
                        <div class="request-detail-label">Hospital</div>
                        <div class="request-detail-value">${request.hospital_name || 'Not specified'}</div>
                    </div>
                    <div class="request-detail-item">
                        <div class="request-detail-label">Requested By</div>
                        <div class="request-detail-value">${request.staff_name || 'Staff'}</div>
                    </div>
                    <div class="request-detail-item">
                        <div class="request-detail-label">Date & Time</div>
                        <div class="request-detail-value">${request.requested_at ? new Date(request.requested_at).toLocaleString() : 'Not available'}</div>
                    </div>
                    ${request.patient_info ? `
                    <div class="request-detail-item" style="grid-column: 1 / -1;">
                        <div class="request-detail-label">Patient Information</div>
                        <div class="request-detail-value">${request.patient_info}</div>
                    </div>` : ''}
                    ${request.notes ? `
                    <div class="request-detail-item" style="grid-column: 1 / -1;">
                        <div class="request-detail-label">Additional Notes</div>
                        <div class="request-detail-value" style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-top: 10px; line-height: 1.6;">
                            ${request.notes}
                        </div>
                    </div>` : ''}
                    ${request.required_by ? `
                    <div class="request-detail-item" style="grid-column: 1 / -1;">
                        <div class="request-detail-label">Required By</div>
                        <div class="request-detail-value">${new Date(request.required_by).toLocaleString()}</div>
                    </div>` : ''}
                `;
                
                document.getElementById('requestDetailsContent').innerHTML = detailsHtml;
            } else {
                document.getElementById('requestDetailsContent').innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 20px;"></i>
                        <h3>Error Loading Details</h3>
                        <p>${result.error || 'Unable to load request information'}</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error:', error);
            document.getElementById('requestDetailsContent').innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #dc3545;">
                    <i class="fas fa-exclamation-triangle fa-2x" style="margin-bottom: 20px;"></i>
                    <h3>Network Error</h3>
                    <p>Failed to load request details. Please check your connection.</p>
                </div>
            `;
        }
    });
});

function closeRequestDetailsModal() {
    document.getElementById('requestDetailsModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('requestDetailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeRequestDetailsModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('requestDetailsModal').style.display === 'flex') {
        closeRequestDetailsModal();
    }
});

// Fulfill request
document.querySelectorAll('.fulfill-request').forEach(button => {
    button.addEventListener('click', async function() {
        const requestId = this.getAttribute('data-request-id');
        
        if (confirm(`Mark request #${requestId} as fulfilled?`)) {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(`/staff/requests/${requestId}/fulfill`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.innerHTML = '<i class="fas fa-check"></i>';
                    this.style.backgroundColor = '#28a745';
                    this.style.color = 'white';
                    this.disabled = true;
                    
                    // Update status in table
                    const row = this.closest('tr');
                    const statusCell = row.cells[4];
                    statusCell.innerHTML = '<span class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;"><i class="fas fa-check-circle"></i> Fulfilled</span>';
                    
                    showToast('Request marked as fulfilled!', 'success');
                } else {
                    alert(`Error: ${result.error}`);
                    this.innerHTML = '<i class="fas fa-check"></i>';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error fulfilling request');
                this.innerHTML = '<i class="fas fa-check"></i>';
            }
        }
    });
});

// Cancel request
document.querySelectorAll('.cancel-request').forEach(button => {
    button.addEventListener('click', async function() {
        const requestId = this.getAttribute('data-request-id');
        
        if (confirm(`Cancel request #${requestId}?`)) {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(`/staff/requests/${requestId}/cancel`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.innerHTML = '<i class="fas fa-times"></i>';
                    this.style.backgroundColor = '#6c757d';
                    this.style.color = 'white';
                    this.disabled = true;
                    
                    // Update status in table
                    const row = this.closest('tr');
                    const statusCell = row.cells[4];
                    statusCell.innerHTML = '<span class="badge" style="background: #6c757d; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85rem;"><i class="fas fa-times-circle"></i> Cancelled</span>';
                    
                    showToast('Request cancelled!', 'info');
                } else {
                    alert(`Error: ${result.error}`);
                    this.innerHTML = '<i class="fas fa-times"></i>';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error cancelling request');
                this.innerHTML = '<i class="fas fa-times"></i>';
            }
        }
    });
});

// Notify donors
document.querySelectorAll('.notify-donors').forEach(button => {
    button.addEventListener('click', async function() {
        const requestId = this.getAttribute('data-request-id');
        const bloodType = this.getAttribute('data-blood-type');
        
        if (confirm(`Send notification to ${bloodType} donors about request #${requestId}?`)) {
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                const response = await fetch(`/staff/requests/${requestId}/notify`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    this.innerHTML = '<i class="fas fa-bell"></i>';
                    showToast(result.message, 'success');
                } else {
                    alert(`Error: ${result.error}`);
                    this.innerHTML = '<i class="fas fa-bell"></i>';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error sending notification');
                this.innerHTML = '<i class="fas fa-bell"></i>';
            }
        }
    });
});

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.right = '20px';
    toast.style.padding = '15px 20px';
    toast.style.borderRadius = '5px';
    toast.style.color = 'white';
    toast.style.zIndex = '10000';
    toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
    
    if (type === 'success') {
        toast.style.backgroundColor = '#28a745';
    } else if (type === 'error') {
        toast.style.backgroundColor = '#dc3545';
    } else {
        toast.style.backgroundColor = '#17a2b8';
    }
    
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
</body>
</html>
