<!DOCTYPE html>
<html>
<head>
    <title>Eligibility - BloodLink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/donor_style.css') }}">
</head>
<body>
<header>
    <div class="header-container">
        <div class="logo">
            <i class="fas fa-tint"></i> BloodLink
        </div>
        <div class="header-right">
            {% if donor %}
            <span class="welcome-text">
                <i class="fas fa-user"></i> Welcome, {{ donor.donor_name }}
            </span>
            {% endif %}
            {% if unread_notifications and unread_notifications > 0 %}
            <a href="{{ url_for('donor_notifications') }}" class="notification-badge">
                <i class="fas fa-bell fa-lg"></i>
                <span class="notification-count">{{ unread_notifications }}</span>
            </a>
            {% endif %}
            <button class="btn btn-menu" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>
</header>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>Menu</span>
        <button class="close-btn" onclick="toggleSidebar()">&times;</button>
    </div>
    <nav class="sidebar-nav">
        <a href="{{ url_for('donor_dashboard') }}"><i class="fas fa-home"></i> Home</a>
        <a href="{{ url_for('donor_appointment') }}"><i class="fas fa-calendar-plus"></i> Book Appointment</a>
        <a href="{{ url_for('donor_eligibility') }}"><i class="fas fa-clipboard-check"></i> Eligibility</a>
        <a href="{{ url_for('donor_medical') }}"><i class="fas fa-file-medical"></i> Medical Info</a>
        <a href="{{ url_for('donor_notifications') }}"><i class="fas fa-bell"></i> Alerts</a>
        <hr>
        <a href="{{ url_for('logout') }}" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
</div>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- Main Content -->
<div class="page-container">
    <div class="card">
        <h2 class="text-center"><i class="fas fa-clipboard-check"></i> Eligibility Status</h2>
        
        <div class="eligibility-status" style="text-align: center; padding: 2rem;">
            <i class="fas fa-user-md fa-3x" style="color: #c00; margin-bottom: 1rem;"></i>
            <p id="status" style="font-size: 1.3rem; font-weight: 600;">Checking your eligibility status...</p>
            <i id="loadingIcon" class="fas fa-circle-notch fa-spin fa-2x" style="color: #c00; margin: 1rem 0;"></i>
            <div id="statusDetails" style="margin-top: 20px; display: none;"></div>
        </div>
        
        <div class="text-center mt-30">
            <a href="{{ url_for('donor_appointment') }}" class="btn btn-outline">
                <i class="fas fa-calendar-plus"></i> Book Donation
            </a>
            <a href="{{ url_for('donor_dashboard') }}" class="btn btn-primary">
                <i class="fas fa-home"></i> Back to Home
            </a>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/donor_script.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    checkEligibilityFromDatabase();
});

function checkEligibilityFromDatabase() {
    const statusElement = document.getElementById('status');
    const loadingIcon = document.getElementById('loadingIcon');
    const statusDetails = document.getElementById('statusDetails');
    
    if (statusElement && loadingIcon) {
        statusElement.textContent = 'Checking your eligibility status...';
        loadingIcon.style.display = 'block';
        
        fetch('/donor/eligibility/check')
            .then(response => response.json())
            .then(data => {
                loadingIcon.style.display = 'none';
                
                if (data.success) {
                    if (data.eligible) {
                        statusElement.innerHTML = '<i class="fas fa-check-circle" style="color: green; margin-right: 10px;"></i> You are eligible to donate!';
                        statusElement.style.color = 'green';
                        
                        statusDetails.innerHTML = `
                            <div style="background: #d4edda; color: #155724; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <p style="margin: 0;">${data.message || 'Based on your medical records and donation history.'}</p>
                            </div>
                        `;
                        statusDetails.style.display = 'block';
                    } else {
                        statusElement.innerHTML = '<i class="fas fa-times-circle" style="color: red; margin-right: 10px;"></i> Not eligible to donate';
                        statusElement.style.color = 'red';
                        
                        let details = `<div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <p style="margin: 0;">${data.reason || 'Medical records indicate temporary ineligibility'}</p>`;
                        
                        if (data.last_donation) {
                            details += `<p style="margin: 1rem 0 0 0;"><strong>Last Donation:</strong> ${new Date(data.last_donation).toLocaleDateString()}</p>`;
                        }
                        
                        details += '</div>';
                        statusDetails.innerHTML = details;
                        statusDetails.style.display = 'block';
                    }
                } else {
                    statusElement.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: orange; margin-right: 10px;"></i> Unable to check eligibility';
                    statusElement.style.color = 'orange';
                    
                    statusDetails.innerHTML = `
                        <div style="background: #fff3cd; color: #856404; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <p style="margin: 0;">Please contact staff for eligibility verification.</p>
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">Error: ${data.error || 'Could not fetch eligibility data'}</p>
                        </div>
                    `;
                    statusDetails.style.display = 'block';
                }
            })
            .catch(error => {
                loadingIcon.style.display = 'none';
                statusElement.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: orange; margin-right: 10px;"></i> Error checking eligibility';
                statusElement.style.color = 'orange';
                
                statusDetails.innerHTML = `
                    <div style="background: #f8d7da; color: #721c24; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                        <p style="margin: 0;">Could not connect to server. Please try again later.</p>
                        <button onclick="checkEligibilityFromDatabase()" class="btn btn-outline" style="margin-top: 10px;">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
                statusDetails.style.display = 'block';
            });
    }
}
</script>
</body>
</html>