<!DOCTYPE html>
<html>
<head>
    <title>Medical Information - BloodLink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/donor_style.css') }}">
</head>
<body>
<header>
    <div class="header-container">
        <div class="logo">
            <i class="fas fa-tint"></i> BloodLink
        </div>
        <div class="header-right">
            <button class="btn btn-menu" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>
</header>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>Menu</span>
        <button class="close-btn" onclick="toggleSidebar()">&times;</button>
    </div>
    <nav class="sidebar-nav">
        <a href="{{ url_for('donor_dashboard') }}"><i class="fas fa-home"></i> Home</a>
        <a href="{{ url_for('donor_appointment') }}"><i class="fas fa-calendar-plus"></i> Book Appointment</a>
        <a href="{{ url_for('donor_eligibility') }}"><i class="fas fa-clipboard-check"></i> Eligibility</a>
        <a href="{{ url_for('donor_medical') }}"><i class="fas fa-file-medical"></i> Medical Info</a>
        <a href="{{ url_for('donor_notifications') }}"><i class="fas fa-bell"></i> Alerts</a>
        <hr>
        <a href="{{ url_for('logout') }}" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
</div>

<div class="page-container">
    <div class="card">
        <h2 class="text-center"><i class="fas fa-file-medical"></i> Medical Information</h2>
        
        <p style="color: #666; margin-bottom: 25px; text-align: center;">
            Please provide any relevant medical history, allergies, medications, or health conditions.
            This information helps ensure your safety during donation.
        </p>
        
        <div class="form-group">
            <label><i class="fas fa-history"></i> Medical History</label>
            <textarea id="medical" rows="4" placeholder="Enter any medical conditions, surgeries, chronic illnesses, or health concerns..."></textarea>
        </div>
        
        <div class="form-group">
            <label><i class="fas fa-prescription-bottle"></i> Current Medications</label>
            <input type="text" id="medications" placeholder="List any medications you're currently taking">
        </div>
        
        <div class="form-group">
            <label><i class="fas fa-allergies"></i> Known Allergies</label>
            <input type="text" id="allergies" placeholder="List any known allergies">
        </div>
        
        <div class="button-group">
            <button class="btn btn-primary" onclick="saveMedicalInfo()">
                <i class="fas fa-save"></i> Save Medical Info
            </button>
            <a href="{{ url_for('donor_eligibility') }}" class="btn btn-outline">
                <i class="fas fa-clipboard-check"></i> Check Eligibility
            </a>
        </div>
        
        <div id="message" style="margin-top: 20px; display: none; padding: 10px; border-radius: 5px;"></div>
    </div>
</div>

<!-- Add sidebar overlay -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<script src="{{ url_for('static', filename='js/donor_script.js') }}"></script>
<script>
// Load existing medical info when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadMedicalInfo();
    console.log('Medical page loaded with sidebar functionality');
});

function loadMedicalInfo() {
    // Fetch existing medical info from database
    fetch('/donor/medical/get')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.medical_info) {
                // Parse and populate the form
                const info = data.medical_info;
                
                // Simple parsing (you might want more robust parsing based on your data structure)
                if (info.includes('Medical History:')) {
                    const parts = info.split('\n');
                    parts.forEach(part => {
                        if (part.startsWith('Medical History:')) {
                            document.getElementById('medical').value = part.replace('Medical History:', '').trim();
                        } else if (part.startsWith('Medications:')) {
                            document.getElementById('medications').value = part.replace('Medications:', '').trim();
                        } else if (part.startsWith('Allergies:')) {
                            document.getElementById('allergies').value = part.replace('Allergies:', '').trim();
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.log('No existing medical info found or error loading:', error);
        });
}

function saveMedicalInfo() {
    const medical = document.getElementById('medical').value;
    const medications = document.getElementById('medications').value;
    const allergies = document.getElementById('allergies').value;
    
    // Combine all medical info
    const combinedText = "Medical History: " + (medical || "None provided") + "\n" +
                        "Medications: " + (medications || "None") + "\n" +
                        "Allergies: " + (allergies || "None");
    
    // Show loading
    const saveBtn = document.querySelector('.btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    saveBtn.disabled = true;
    
    // Save to database
    fetch('/donor/medical/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            medical_history: combinedText
        })
    })
    .then(response => response.json())
    .then(data => {
        const messageDiv = document.getElementById('message');
        if (data.success) {
            messageDiv.style.backgroundColor = '#d4edda';
            messageDiv.style.color = '#155724';
            messageDiv.textContent = 'Medical information saved successfully!';
            messageDiv.style.display = 'block';
            
            // Show saved state on button
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
            saveBtn.style.backgroundColor = '#28a745';
            
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.style.backgroundColor = '';
                saveBtn.disabled = false;
            }, 2000);
        } else {
            messageDiv.style.backgroundColor = '#f8d7da';
            messageDiv.style.color = '#721c24';
            messageDiv.textContent = 'Error: ' + (data.error || 'Failed to save');
            messageDiv.style.display = 'block';
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        }
        
        // Hide message after 5 seconds
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    })
    .catch(error => {
        const messageDiv = document.getElementById('message');
        messageDiv.style.backgroundColor = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.textContent = 'Network error. Please try again.';
        messageDiv.style.display = 'block';
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
        
        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    });
}
</script>
</body>
</html>