<!DOCTYPE html>
<html>
<head>
    <title>Book Appointment - BloodLink</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
<header>
    <div class="header-container">
        <div class="logo">
            <i class="fas fa-tint"></i> BloodLink
        </div>
        <div class="header-right">
            {% if donor %}
            <span class="welcome-text">
                <i class="fas fa-user"></i> Welcome, {{ donor.donor_name }}
            </span>
            {% endif %}
            <button class="btn btn-menu" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>
</header>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <span>Menu</span>
        <button class="close-btn" onclick="toggleSidebar()">&times;</button>
    </div>
    <nav class="sidebar-nav">
        <a href="{{ url_for('donor_dashboard') }}"><i class="fas fa-home"></i> Home</a>
        <a href="{{ url_for('donor_appointment') }}"><i class="fas fa-calendar-plus"></i> Book Appointment</a>
        <a href="{{ url_for('donor_eligibility') }}"><i class="fas fa-clipboard-check"></i> Eligibility</a>
        <a href="{{ url_for('donor_medical') }}"><i class="fas fa-file-medical"></i> Medical Info</a>
        <a href="{{ url_for('donor_notifications') }}"><i class="fas fa-bell"></i> Alerts</a>
        <hr>
        <a href="{{ url_for('logout') }}" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </nav>
</div>

<div class="sidebar-overlay" onclick="toggleSidebar()"></div>

<div class="container-small">
    <div class="card">
        <h2 class="text-center"><i class="fas fa-calendar-plus"></i> Available Events</h2>
        
        <!-- Simple eligibility check -->
        {% if donor and not donor.eligibility_status %}
        <div class="alert" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
            <i class="fas fa-exclamation-triangle" style="color: #856404;"></i>
            <strong>Note:</strong> You must be eligible to donate blood to register for events. 
            <a href="{{ url_for('donor_eligibility') }}" style="color: var(--primary-red); text-decoration: underline;">Check your eligibility</a> first.
        </div>
        {% endif %}
        
        <!-- Events List -->
        <div class="events-container">
            {% if events %}
                {% for event in events %}
                <div class="event-card" style="border: 1px solid var(--border-light); border-radius: 8px; padding: 20px; margin-bottom: 15px; background: white;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div>
                            <h3 style="margin: 0 0 10px; color: var(--primary-red);">
                                <i class="fas fa-hospital"></i> {{ event.event_name }}
                                {% if event.is_cancelled %}
                                <span style="font-size: 0.8rem; background: #f8d7da; color: #721c24; padding: 2px 8px; border-radius: 10px; margin-left: 10px;">
                                    CANCELLED
                                </span>
                                {% elif event.is_past %}
                                <span style="font-size: 0.8rem; background: #e9ecef; color: #6c757d; padding: 2px 8px; border-radius: 10px; margin-left: 10px;">
                                    PAST EVENT
                                </span>
                                {% endif %}
                            </h3>
                            
                            <!-- Event details grid -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-bottom: 10px;">
                                <div>
                                    <i class="fas fa-calendar-day"></i> 
                                    <strong>Date:</strong> {{ event.event_date }}
                                </div>
                                <div>
                                    <i class="fas fa-clock"></i> 
                                    <strong>Time:</strong> {{ event.event_time }}
                                </div>
                                <div>
                                    <i class="fas fa-map-marker-alt"></i> 
                                    <strong>Location:</strong> {{ event.location }}
                                </div>
                                <div>
                                    <i class="fas fa-tint"></i> 
                                    <strong>Status:</strong> {{ event.status or 'Upcoming' }}
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: right; min-width: 150px;">
                            {% if event.already_registered %}
                            <button class="btn btn-outline" style="cursor: default; opacity: 0.7;" disabled>
                                <i class="fas fa-check-circle"></i> Registered
                            </button>
                            
                            {% elif event.is_cancelled %}
                            <button class="btn btn-outline" style="cursor: default; opacity: 0.7; background: #f8d7da; color: #721c24;" disabled>
                                <i class="fas fa-times-circle"></i> Cancelled
                            </button>
                            
                            {% elif event.is_past %}
                            <button class="btn btn-outline" style="cursor: default; opacity: 0.7; background: #e9ecef; color: #6c757d;" disabled>
                                <i class="fas fa-history"></i> Past Event
                            </button>
                            
                            {% elif not donor.eligibility_status %}
                            <button class="btn btn-outline" style="cursor: default; opacity: 0.7;" disabled>
                                <i class="fas fa-calendar-check"></i> Not Eligible
                            </button>
                            
                            {% elif event.can_register %}
                            <button class="btn btn-primary register-btn" data-event-id="{{ event.id }}">
                                <i class="fas fa-calendar-check"></i> Register Now
                            </button>
                            
                            {% else %}
                            <button class="btn btn-outline" style="cursor: default; opacity: 0.7;" disabled>
                                <i class="fas fa-calendar-check"></i> Register
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if event.description %}
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-light);">
                        <p style="margin: 0; color: var(--text-medium);">
                            <i class="fas fa-info-circle"></i> {{ event.description }}
                        </p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
            <div style="text-align: center; padding: 40px; color: var(--text-light);">
                <i class="fas fa-calendar-times fa-3x" style="margin-bottom: 20px;"></i>
                <h3>No Events Available</h3>
                <p>There are currently no blood donation events scheduled.</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Existing Registrations Section -->
    {% if registered_event_ids and events %}
    <div class="card" style="margin-top: 30px;">
        <h3 class="text-center"><i class="fas fa-calendar-check"></i> Your Registrations</h3>
        
        <div style="max-height: 400px; overflow-y: auto;">
            {% for event in events %}
                {% if event.id in registered_event_ids %}
                <div class="registration-item" style="border: 1px solid var(--border-light); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0 0 5px;">{{ event.event_name }}</h4>
                            <p style="margin: 5px 0; color: var(--text-light);">
                                <i class="fas fa-calendar"></i> {{ event.event_date }} at {{ event.event_time }}
                            </p>
                            <p style="margin: 5px 0; color: var(--text-light);">
                                <i class="fas fa-map-marker-alt"></i> {{ event.location }}
                            </p>
                            {% if event.is_cancelled %}
                            <p style="margin: 5px 0; color: #dc3545;">
                                <i class="fas fa-exclamation-triangle"></i> This event has been cancelled
                            </p>
                            {% endif %}
                        </div>
                        <div>
                            <span style="display: inline-block; padding: 5px 15px; border-radius: 20px; font-weight: 600; 
                                         background: #fff3cd; 
                                         color: #856404;">
                                Registered
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle registration buttons
    const registerButtons = document.querySelectorAll('.register-btn');
    
    registerButtons.forEach(button => {
        button.addEventListener('click', async function() {
            const eventId = this.getAttribute('data-event-id');
            const originalText = this.innerHTML;
            
            // Show loading state
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Registering...';
            this.disabled = true;
            
            try {
                const response = await fetch('/donor/appointment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event_id: eventId })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Successfully registered for the event!');
                    window.location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Failed to register'));
                    this.innerHTML = originalText;
                    this.disabled = false;
                }
            } catch (error) {
                alert('Network error. Please try again.');
                console.error('Error:', error);
                this.innerHTML = originalText;
                this.disabled = false;
            }
        });
    });
});
</script>
</body>
</html>
